# MimicWX-Linux ğŸ§

**é›¶é£é™©å¾®ä¿¡è‡ªåŠ¨åŒ–æ¡†æ¶** â€” åŸºäº AT-SPI2 æ— éšœç¢æ¥å£ + X11 XTEST è¾“å…¥æ³¨å…¥ + SQLCipher æ•°æ®åº“è§£å¯†

> Zero-risk WeChat automation framework for Linux via AT-SPI2 accessibility + X11 XTEST input injection + SQLCipher database decryption

---

## âœ¨ ç‰¹æ€§

- ğŸ” **åŒé€šé“æ¶ˆæ¯æ£€æµ‹**
  - **æ•°æ®åº“é€šé“** (ä¸») â€” SQLCipher è§£å¯† WCDB + fanotify WAL å®æ—¶ç›‘å¬ï¼Œäºšç§’çº§å»¶è¿Ÿ
  - **AT-SPI2 é€šé“** (å¤‡) â€” æ— éšœç¢æ¥å£è¯»å– UI æ¶ˆæ¯åˆ—è¡¨ï¼Œæ— éœ€æ³¨å…¥è¿›ç¨‹
- âŒ¨ï¸ **X11 XTEST è¾“å…¥æ³¨å…¥** â€” é€šè¿‡ XTEST æ‰©å±•ç›´æ¥æ³¨å…¥é”®é¼ äº‹ä»¶ï¼Œé›¶ Synthetic æ ‡è®°ï¼ŒåŸç”ŸX11çª—å£ç®¡ç†
- ğŸ”‘ **GDB è‡ªåŠ¨å¯†é’¥æå–** â€” åœ¨ `setCipherKey` åç§»å¤„è®¾æ–­ç‚¹ï¼Œç”¨æˆ·æ‰«ç ç™»å½•åè‡ªåŠ¨ä»å¯„å­˜å™¨æ•è· 32 å­—èŠ‚ AES å¯†é’¥
- ğŸ’¬ **ç‹¬ç«‹èŠå¤©çª—å£** â€” å€Ÿé‰´ [wxauto](https://github.com/cluic/wxauto) çš„ ChatWnd è®¾è®¡ï¼Œæ”¯æŒå¤šçª—å£å¹¶è¡Œæ”¶å‘æ¶ˆæ¯
- ğŸ”Œ **REST + WebSocket API** â€” æä¾›å®Œæ•´çš„ HTTP API å’Œ WebSocket å®æ—¶æ¨é€ï¼Œå¯å¯¹æ¥ Yunzai ç­‰æœºå™¨äººæ¡†æ¶
- ğŸ³ **Docker ä¸€é”®éƒ¨ç½²** â€” å¤šé˜¶æ®µæ„å»º + Xvfb/VNC è™šæ‹Ÿæ¡Œé¢ï¼Œå¼€ç®±å³ç”¨
- ğŸ”’ **Token è®¤è¯** â€” æ”¯æŒ Bearer Token è®¤è¯ä¿æŠ¤ API å®‰å…¨

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€ Docker å®¹å™¨ (Ubuntu 22.04) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  â”Œâ”€ æ¡Œé¢ç¯å¢ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Xvfb (è™šæ‹Ÿæ˜¾ç¤º :1)  â†â†’  TigerVNC  â†â†’  noVNC (æµè§ˆå™¨è¿œç¨‹æ¡Œé¢)      â”‚ â”‚
â”‚  â”‚  XFCE4 æ¡Œé¢  +  WeChat Linux ç‰ˆ                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€ MimicWX æ ¸å¿ƒ (Rust) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€ æ¶ˆæ¯æ£€æµ‹å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  db.rs:    SQLCipher è§£å¯† â†’ fanotify WAL ç›‘å¬ â†’ å¢é‡æ¶ˆæ¯æ‹‰å–  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  atspi.rs: D-Bus â†’ AT-SPI2 Registry â†’ èŠ‚ç‚¹éå†/å±æ€§è¯»å–       â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€ è¾“å…¥æ§åˆ¶å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  input.rs: X11 XTEST é”®é¼ æ³¨å…¥ + xclip å‰ªè´´æ¿ + çª—å£ç®¡ç†       â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€ ä¸šåŠ¡é€»è¾‘å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  wechat.rs:  ä¼šè¯ç®¡ç† / æ¶ˆæ¯å‘é€ / æ§ä»¶æŸ¥æ‰¾ / çŠ¶æ€æ£€æµ‹         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  chatwnd.rs: ç‹¬ç«‹èŠå¤©çª—å£ç®¡ç† (å¤šçª—å£å¹¶è¡Œ)                     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€ API å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  api.rs: axum HTTP + WebSocket (OneBot-like æ¥å£)               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  main.rs: å¯åŠ¨ç¼–æ’ / é…ç½®åŠ è½½ / æ¶ˆæ¯å¾ªç¯                       â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€ è¾…åŠ©è„šæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  start.sh:       å®¹å™¨å¯åŠ¨ç¼–æ’ (D-Bus â†’ VNC â†’ AT-SPI2 â†’ å¾®ä¿¡ â†’ æœåŠ¡) â”‚ â”‚
â”‚  â”‚  extract_key.py: GDB Python è„šæœ¬ â€” è‡ªåŠ¨æå– WCDB åŠ å¯†å¯†é’¥          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ å¤–éƒ¨å¯¹æ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  adapter/MimicWX.js: Yunzai-Bot é€‚é…å™¨ (REST + WebSocket åŒé€šé“)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
MimicWX-Linux/
â”œâ”€â”€ src/                        # Rust æºä»£ç 
â”‚   â”œâ”€â”€ main.rs                 # å…¥å£: å¯åŠ¨ç¼–æ’ã€é…ç½®åŠ è½½ã€æ¶ˆæ¯å¾ªç¯
â”‚   â”œâ”€â”€ atspi.rs                # AT-SPI2 åº•å±‚åŸè¯­ (D-Bus é€šä¿¡ã€èŠ‚ç‚¹éå†)
â”‚   â”œâ”€â”€ input.rs                # X11 XTEST è¾“å…¥å¼•æ“ (é”®é¼ æ³¨å…¥ã€çª—å£ç®¡ç†)
â”‚   â”œâ”€â”€ wechat.rs               # å¾®ä¿¡ä¸šåŠ¡é€»è¾‘ (ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯å‘é€/éªŒè¯)
â”‚   â”œâ”€â”€ chatwnd.rs              # ç‹¬ç«‹èŠå¤©çª—å£ (ChatWnd æ¨¡å¼)
â”‚   â”œâ”€â”€ db.rs                   # æ•°æ®åº“ç›‘å¬ (SQLCipher + fanotify WAL)
â”‚   â””â”€â”€ api.rs                  # HTTP/WebSocket API (axum)
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ start.sh                # å®¹å™¨å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ extract_key.py          # GDB å¯†é’¥æå–è„šæœ¬
â”‚   â””â”€â”€ dbus-mimicwx.conf       # D-Bus é…ç½® (å…è®¸ eavesdrop)
â”œâ”€â”€ adapter/
â”‚   â””â”€â”€ MimicWX.js              # Yunzai-Bot é€‚é…å™¨
â”œâ”€â”€ Cargo.toml                  # Rust ä¾èµ– & æ„å»ºé…ç½®
â”œâ”€â”€ Dockerfile                  # å¤šé˜¶æ®µæ„å»º (builder + runtime)
â”œâ”€â”€ docker-compose.yml          # ç¼–æ’é…ç½®
â””â”€â”€ config.toml                 # è¿è¡Œæ—¶é…ç½®æ–‡ä»¶
```

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### `atspi.rs` â€” AT-SPI2 åº•å±‚åŸè¯­

é€šè¿‡ `zbus` è¿æ¥ AT-SPI2 D-Busï¼Œå°è£…èŠ‚ç‚¹éå†å’Œå±æ€§è¯»å–ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **å¤šç­–ç•¥è¿æ¥** | `org.a11y.Bus` â†’ `AT_SPI_BUS_ADDRESS` ç¯å¢ƒå˜é‡ â†’ `~/.cache/at-spi/` socket æ‰«æ |
| **è¿è¡Œæ—¶é‡è¿** | Registry æŒç»­è¿”å› 0 å­èŠ‚ç‚¹æ—¶è‡ªåŠ¨é‡æ–°å‘ç° AT-SPI2 bus |
| **èŠ‚ç‚¹æ“ä½œ** | `child_count` / `child_at` / `name` / `role` / `bbox` / `text` / `parent` / `get_states` |
| **æœç´¢åŸè¯­** | BFS å¹¿åº¦æœç´¢ + DFS æ·±åº¦æœç´¢ï¼Œæ”¯æŒ role/name è¿‡æ»¤ |
| **è¶…æ—¶ä¿æŠ¤** | æ‰€æœ‰ D-Bus è°ƒç”¨å¸¦ 500ms è¶…æ—¶ |

### `input.rs` â€” X11 XTEST è¾“å…¥å¼•æ“

é€šè¿‡ `x11rb` ä½¿ç”¨ XTEST æ‰©å±•æ³¨å…¥è¾“å…¥äº‹ä»¶ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **é”®ç›˜** | å•é”®æŒ‰ä¸‹ / ç»„åˆé”® (`Ctrl+V`, `Ctrl+A` ç­‰) / ASCII é€å­—è¾“å…¥ |
| **ä¸­æ–‡è¾“å…¥** | `xclip` å†™å…¥å‰ªè´´æ¿ â†’ `Ctrl+V` ç²˜è´´ (ç»•è¿‡è¾“å…¥æ³•) |
| **å›¾ç‰‡å‘é€** | `xclip -selection clipboard -t image/png` â†’ `Ctrl+V` ç²˜è´´ |
| **é¼ æ ‡** | ç§»åŠ¨ / å•å‡» / åŒå‡» / å³é”® / æ»šè½® |
| **çª—å£ç®¡ç†** | X11 åŸç”Ÿ `_NET_ACTIVE_WINDOW` æ¿€æ´» / `_NET_CLOSE_WINDOW` å…³é—­ (æ›¿ä»£ xdotool) |

### `db.rs` â€” æ•°æ®åº“ç›‘å¬ (1332 è¡Œæ ¸å¿ƒæ¨¡å—)

SQLCipher è§£å¯†å¾®ä¿¡ WCDB æ•°æ®åº“ + fanotify å®æ—¶ç›‘å¬ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **SQLCipher è§£å¯†** | `rusqlite` + `bundled-sqlcipher-vendored-openssl`ï¼Œä½¿ç”¨ GDB æå–çš„å¯†é’¥ |
| **æŒä¹…è¿æ¥æ± ** | å¤šä¸ª `message_N.db` ä¿æŒé•¿è¿æ¥ï¼Œé¿å…é‡å¤è§£å¯†æ¡æ‰‹ |
| **WAL ç›‘å¬** | `fanotify` + PID è¿‡æ»¤ (åªç›‘å¬å¾®ä¿¡è¿›ç¨‹å†™å…¥)ï¼Œæ— éœ€é˜²æŠ– |
| **å¢é‡æ¶ˆæ¯** | æ¯ä¸ªæ¶ˆæ¯è¡¨ç»´æŠ¤ `last_local_id` é«˜æ°´ä½æ ‡è®° |
| **è”ç³»äººç¼“å­˜** | ä» `contact.db` + `group_contact.db` åŠ è½½è”ç³»äºº/ç¾¤æˆå‘˜ |
| **æ¶ˆæ¯è§£æ** | æ”¯æŒæ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³/è§†é¢‘/è¡¨æƒ…/åç‰‡/é“¾æ¥/å°ç¨‹åº/æ–‡ä»¶/è½¬è´¦/çº¢åŒ…/ç³»ç»Ÿæ¶ˆæ¯ |
| **WCDB å…¼å®¹** | Zstd BLOB è§£å‹ + TEXT/BLOB è‡ªé€‚åº”è¯»å– |
| **å‘é€éªŒè¯** | è®¢é˜…è‡ªå‘æ¶ˆæ¯å¹¿æ’­ï¼Œäº‹ä»¶é©±åŠ¨éªŒè¯å‘é€ç»“æœ |

### `wechat.rs` â€” å¾®ä¿¡ä¸šåŠ¡é€»è¾‘

åŸºäº AT-SPI2 çš„å¾®ä¿¡ UI è‡ªåŠ¨åŒ–ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **çŠ¶æ€æ£€æµ‹** | é€šè¿‡ `[tool bar] "å¯¼èˆª"` åˆ¤æ–­ç™»å½•çŠ¶æ€ (æœªè¿è¡Œ/ç­‰å¾…æ‰«ç /å·²ç™»å½•) |
| **æ§ä»¶æŸ¥æ‰¾** | å¯¼èˆªæ  / split pane / ä¼šè¯åˆ—è¡¨ / æ¶ˆæ¯åˆ—è¡¨ / è¾“å…¥æ¡† |
| **ä¼šè¯ç®¡ç†** | åˆ—è¡¨è·å– / åˆ‡æ¢ (ChatWith) / æ–°æ¶ˆæ¯æ£€æŸ¥ / Ctrl+F æœç´¢å›é€€ |
| **æ¶ˆæ¯å‘é€** | åˆ‡æ¢ä¼šè¯ â†’ ç²˜è´´æ–‡æœ¬ â†’ Enter å‘é€ â†’ æ•°æ®åº“éªŒè¯ |
| **å›¾ç‰‡å‘é€** | ä¼˜å…ˆç‹¬ç«‹çª—å£ï¼Œå›é€€ä¸»çª—å£ |
| **ç‹¬ç«‹çª—å£** | å¼¹å‡º (`add_listen`) / å…³é—­ (`remove_listen`) / æ¶ˆæ¯è½®è¯¢ |

### `chatwnd.rs` â€” ç‹¬ç«‹èŠå¤©çª—å£

æ¯ä¸ªç‹¬ç«‹å¼¹å‡ºçš„èŠå¤©çª—å£æ‹¥æœ‰ç‹¬ç«‹çš„ AT-SPI2 èŠ‚ç‚¹ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **çª—å£ç®¡ç†** | åˆ›å»º / å­˜æ´»æ£€æŸ¥ / èŠ‚ç‚¹åˆ·æ–° / é”€æ¯ |
| **æ¶ˆæ¯è¯»å–** | å…¨é‡è¯»å– / å¢é‡è¯»å– (`last_count` è¿½è¸ª) / æ ‡è®°å·²è¯» |
| **æ¶ˆæ¯å‘é€** | æ¿€æ´»çª—å£ â†’ å‘é€æ–‡æœ¬/å›¾ç‰‡ â†’ éªŒè¯ |

### `api.rs` â€” HTTP + WebSocket API

åŸºäº `axum` çš„ REST API + WebSocket å®æ—¶æ¨é€ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/status` | GET | æœåŠ¡çŠ¶æ€ (å…è®¤è¯) |
| `/contacts` | GET | è”ç³»äººåˆ—è¡¨ (æ•°æ®åº“) |
| `/sessions` | GET | ä¼šè¯åˆ—è¡¨ (ä¼˜å…ˆæ•°æ®åº“) |
| `/messages/new` | GET | æ–°æ¶ˆæ¯ (æ•°æ®åº“å¢é‡) |
| `/send` | POST | å‘é€æ–‡æœ¬æ¶ˆæ¯ |
| `/send_image` | POST | å‘é€å›¾ç‰‡ (base64) |
| `/chat` | POST | åˆ‡æ¢èŠå¤©ç›®æ ‡ |
| `/listen` | POST | æ·»åŠ /æŸ¥çœ‹ç›‘å¬ç›®æ ‡ |
| `/listen` | DELETE | ç§»é™¤ç›‘å¬ç›®æ ‡ |
| `/listen/messages` | GET | AT-SPI ç›‘å¬æ¶ˆæ¯ |
| `/ws` | GET | WebSocket å®æ—¶æ¶ˆæ¯æ¨é€ |
| `/debug/tree` | GET | AT-SPI2 æ§ä»¶æ ‘ (è°ƒè¯•) |
| `/debug/session_tree` | GET | ä¼šè¯å®¹å™¨æ ‘ (è°ƒè¯•) |

> è®¤è¯æ–¹å¼: `Header "Authorization: Bearer <token>"` æˆ– `Query "?token=<token>"`

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Linux ç³»ç»Ÿ (Ubuntu 22.04+ æ¨è)
- Docker + Docker Compose
- å…è®¸ `SYS_ADMIN` / `SYS_PTRACE` èƒ½åŠ› (å¯†é’¥æå– + fanotify éœ€è¦)

### ä¸€é”®éƒ¨ç½²

```bash
git clone https://github.com/PigeonCoders/MimicWX-Linux.git
cd MimicWX-Linux
docker compose up -d
```

### æˆ–æ‰‹åŠ¨ Docker æ„å»º

```bash
docker build -t mimicwx .
docker run -d --name mimicwx \
  --cap-add SYS_ADMIN \
  --cap-add SYS_PTRACE \
  --security-opt seccomp=unconfined \
  --security-opt apparmor=unconfined \
  -p 5901:5901 \
  -p 6080:6080 \
  -p 8899:8899 \
  --shm-size 512m \
  mimicwx
```

### é¦–æ¬¡ä½¿ç”¨

1. æ‰“å¼€ noVNC: `http://HOST:6080/vnc.html` (å¯†ç : `mimicwx`)
2. åœ¨è™šæ‹Ÿæ¡Œé¢ä¸­æ‰«ç ç™»å½•å¾®ä¿¡
3. GDB è‡ªåŠ¨æå–æ•°æ®åº“å¯†é’¥ â†’ MimicWX è‡ªåŠ¨å¯åŠ¨
4. é€šè¿‡ API æ¥å£å¼€å§‹ä½¿ç”¨

### è®¿é—®å…¥å£

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| noVNC | `http://HOST:6080/vnc.html` | æµè§ˆå™¨è¿œç¨‹æ¡Œé¢ (å¯†ç : `mimicwx`) |
| VNC | `vnc://HOST:5901` | VNC å®¢æˆ·ç«¯è¿æ¥ |
| API | `http://HOST:8899` | REST API æ¥å£ |
| WebSocket | `ws://HOST:8899/ws` | å®æ—¶æ¶ˆæ¯æ¨é€ |

---

## âš™ï¸ é…ç½®æ–‡ä»¶

`config.toml` â€” é…ç½®æœç´¢ä¼˜å…ˆçº§: `./config.toml` â†’ `/home/wechat/mimicwx-linux/config.toml` â†’ `/etc/mimicwx/config.toml`

```toml
[api]
# API è®¤è¯ Token (ç•™ç©ºåˆ™ä¸å¯ç”¨è®¤è¯)
# è¯·æ±‚æ–¹å¼: Header "Authorization: Bearer <token>" æˆ– Query "?token=<token>"
token = "your-secret-token"

[listen]
# å¯åŠ¨åè‡ªåŠ¨å¼¹å‡ºç‹¬ç«‹çª—å£å¹¶ç›‘å¬çš„å¯¹è±¡
# å¡«å…¥è”ç³»äººåç§°æˆ–ç¾¤åç§° (ä¸å¾®ä¿¡æ˜¾ç¤ºåä¸€è‡´)
auto = ["æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹", "å¥½å‹A", "å·¥ä½œç¾¤"]
```

---

## ğŸ”§ å¯¹æ¥ Yunzai-Bot

é¡¹ç›®å†…ç½® Yunzai-Bot v3 é€‚é…å™¨ (`adapter/MimicWX.js`)ï¼Œæ”¯æŒï¼š

- REST API + WebSocket åŒé€šé“é€šä¿¡
- è‡ªåŠ¨è§£ææ•°æ®åº“æ¶ˆæ¯ (æ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³/è§†é¢‘/è¡¨æƒ…/é“¾æ¥)
- æ™ºèƒ½æ¶ˆæ¯åˆ†æ®µå‘é€ (æ–‡æœ¬ + å›¾ç‰‡åˆ†ç¦»)
- ç§èŠ/ç¾¤èŠæ¶ˆæ¯è·¯ç”±
- å¥½å‹/ç¾¤åˆ—è¡¨è‡ªåŠ¨åŒæ­¥

```bash
# ç¯å¢ƒå˜é‡
export MIMICWX_URL="http://localhost:8899"      # API åœ°å€
export MIMICWX_TOKEN="your-secret-token"         # è®¤è¯ Token
```

---

## ğŸ”‘ å¯†é’¥æå–åŸç†

```
WeChat è¿›ç¨‹å¯åŠ¨
      â”‚
      â–¼
GDB attach (start.sh è‡ªåŠ¨è§¦å‘)
      â”‚
      â–¼
åœ¨ setCipherKey åç§» (0x6586C90) è®¾æ–­ç‚¹
      â”‚
      â–¼
ç”¨æˆ·æ‰«ç ç™»å½• â†’ å¾®ä¿¡è°ƒç”¨ setCipherKey æ‰“å¼€æ•°æ®åº“
      â”‚
      â–¼
æ–­ç‚¹è§¦å‘ â†’ ä» $rsi å¯„å­˜å™¨è¯»å– Data ç»“æ„ä½“
      â”‚
      â–¼
æå– 32 å­—èŠ‚ AES å¯†é’¥ â†’ ä¿å­˜è‡³ /tmp/wechat_key.txt
      â”‚
      â–¼
GDB detach â†’ å¾®ä¿¡æ­£å¸¸è¿è¡Œ â†’ MimicWX è¯»å–å¯†é’¥ â†’ è§£å¯†æ•°æ®åº“
```

> âš ï¸ å¯†é’¥åç§»é‡ `0x6586C90` å¯¹åº” WeChat Linux 4.1.0.16 ç‰ˆæœ¬ï¼Œå‡çº§å¾®ä¿¡åå¯èƒ½éœ€è¦æ›´æ–°ã€‚

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| è¯­è¨€ | **Rust** | å¼‚æ­¥é«˜æ€§èƒ½ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€ |
| å¼‚æ­¥è¿è¡Œæ—¶ | **Tokio** | å…¨åŠŸèƒ½å¼‚æ­¥è¿è¡Œæ—¶ |
| æ¶ˆæ¯æ£€æµ‹ | **SQLCipher** + **fanotify** | æ•°æ®åº“è§£å¯† + WAL å®æ—¶ç›‘å¬ |
| æ¶ˆæ¯æ£€æµ‹ (å¤‡ç”¨) | **AT-SPI2** (`atspi-rs` + `zbus`) | D-Bus æ— éšœç¢æ¥å£ |
| è¾“å…¥æ³¨å…¥ | **X11 XTEST** (`x11rb`) | åŸç”Ÿ X11 æ‰©å±•ï¼Œæ›¿ä»£ uinput/xdotool |
| API æœåŠ¡ | **axum** | HTTP + WebSocket |
| åºåˆ—åŒ– | **serde** + **serde_json** | JSON åºåˆ—åŒ–/ååºåˆ—åŒ– |
| XML è§£æ | **quick-xml** | å¾®ä¿¡æ¶ˆæ¯ XML è§£æ |
| å‹ç¼© | **zstd** | WCDB Zstd BLOB è§£å‹ |
| å®¹å™¨åŒ– | **Docker** (Ubuntu 22.04) | å¤šé˜¶æ®µæ„å»º |
| è™šæ‹Ÿæ¡Œé¢ | **TigerVNC** + **noVNC** | è¿œç¨‹æ¡Œé¢è®¿é—® |
| å¯†é’¥æå– | **GDB** + **Python** | è¿è¡Œæ—¶å†…å­˜æ–­ç‚¹ |

---

## ğŸ“Š å¯åŠ¨æµç¨‹

```
å®¹å™¨å¯åŠ¨ (start.sh)
 â”œâ”€â”€ 0) ç³»ç»ŸæœåŠ¡: D-Bus daemon + ptrace è®¾ç½® + æƒé™ä¿®å¤
 â”œâ”€â”€ 1) D-Bus session bus
 â”œâ”€â”€ 2) VNC + XFCE æ¡Œé¢ (1280Ã—720)
 â”œâ”€â”€ 3) æ¸…ç† XFCE è‡ªå¯çš„ AT-SPI2 (é¿å… bus å†²çª)
 â”œâ”€â”€ 4) å¯åŠ¨å”¯ä¸€çš„ AT-SPI2 bus
 â”œâ”€â”€ 5) è·å– AT-SPI2 bus åœ°å€ â†’ ä¿å­˜ç¯å¢ƒå˜é‡
 â”œâ”€â”€ 6) å¯åŠ¨å¾®ä¿¡ â†’ ç­‰å¾…çª—å£å°±ç»ª
 â”œâ”€â”€ GDB å¯†é’¥æå– (åå°, ç­‰å¾…ç”¨æˆ·æ‰«ç )
 â”œâ”€â”€ 7) noVNC (websockify)
 â””â”€â”€ 8) MimicWX ä¸»æœåŠ¡
      â”œâ”€â”€ AT-SPI2 è¿æ¥ (å¸¦é‡è¯•)
      â”œâ”€â”€ X11 XTEST è¾“å…¥å¼•æ“
      â”œâ”€â”€ ç­‰å¾…å¾®ä¿¡ç™»å½•
      â”œâ”€â”€ è¯»å–å¯†é’¥ â†’ DbManager åˆå§‹åŒ–
      â”œâ”€â”€ InputEngine Actor (mpsc é˜Ÿåˆ—)
      â”œâ”€â”€ API æœåŠ¡ (axum :8899)
      â”œâ”€â”€ æ•°æ®åº“æ¶ˆæ¯ç›‘å¬ä»»åŠ¡ (fanotify)
      â””â”€â”€ è‡ªåŠ¨ç›‘å¬ä»»åŠ¡ (config.toml auto)
```

---

## ğŸ“ API ä½¿ç”¨ç¤ºä¾‹

### æŸ¥è¯¢çŠ¶æ€
```bash
curl http://localhost:8899/status
```

### å‘é€æ¶ˆæ¯
```bash
curl -X POST http://localhost:8899/send \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{"to": "æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹", "text": "Hello from MimicWX!"}'
```

### å‘é€å›¾ç‰‡ (base64)
```bash
curl -X POST http://localhost:8899/send_image \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{"to": "æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹", "file": "<base64-data>", "name": "test.png"}'
```

### æ·»åŠ ç›‘å¬
```bash
curl -X POST http://localhost:8899/listen \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{"who": "å¥½å‹A"}'
```

### WebSocket è¿æ¥
```javascript
const ws = new WebSocket("ws://localhost:8899/ws?token=your-token")
ws.onmessage = (e) => console.log(JSON.parse(e.data))
```

---

## License

MIT
